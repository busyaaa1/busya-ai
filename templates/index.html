<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Busya-AI v2.0</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css"> 
</head>
<body>
    
    <div class="main-layout">
        
        <div id="sidebar">
            <button id="new-chat-btn"><span class="material-icons">add</span> Новый Чат</button>
            <div id="chat-list">
                <div class="chat-item active">Приветственный Чат</div>
                <div class="chat-item">Идея для стартапа</div>
                <div class="chat-item">Что подарить подруге</div>
            </div>

            <div id="settings-area">
                <button onclick="toggleTheme()">
                    <span class="material-icons" id="theme-icon">light_mode</span> Режим
                </button>
                <button onclick="alert('Для входа нужен Google OAuth и База Данных!')">
                    <span class="material-icons">account_circle</span> Войти
                </button>
            </div>
        </div>

        <div id="chat-main">
            <div id="welcome">
                <h1><span class="gradient">Чем могу помочь, солнышко?</span></h1>
            </div>

            <div id="chat">
                </div>

            <div class="input-box-wrapper">
                <div class="input-box">
                    
                    <button id="attach-btn" title="Загрузка файлов (пока недоступно)">
                         <span class="material-icons">attach_file</span>
                    </button>

                    <textarea id="msg" placeholder="Сообщение для Busya-AI..." rows="1" autocomplete="off"></textarea>
                    
                    <button id="send-btn" onclick="send()">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        // ===================================================================
        // 1. UI/UX: Темы и Textarea
        // ===================================================================
        
        const chat = document.getElementById("chat");
        const textarea = document.getElementById('msg');
        let firstMessage = true;

        // Автоматическое расширение textarea
        function autoResize() {
            textarea.style.height = '1px';
            const maxHeight = 150; 
            let newHeight = textarea.scrollHeight;
            
            if (newHeight > maxHeight) {
                newHeight = maxHeight;
                textarea.style.overflowY = 'auto'; 
            } else {
                textarea.style.overflowY = 'hidden'; 
            }
            textarea.style.height = newHeight + 'px';
        }

        // Переключение Тёмного/Светлого режима
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('busya-theme', isDarkMode ? 'dark' : 'light');
            
            document.getElementById('theme-icon').textContent = isDarkMode ? 'dark_mode' : 'light_mode';
        }

        // Загрузка настроек при старте
        window.onload = function() {
            const savedTheme = localStorage.getItem('busya-theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = 'dark_mode';
            }
            autoResize(); // Инициализация
            textarea.addEventListener('input', autoResize, false);
        }

        // Обработка Enter (отправка) и Shift+Enter (новая строка)
        textarea.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault(); 
                send();
            }
        });

        // ===================================================================
        // 2. ГЛАВНАЯ ФУНКЦИЯ: СТРИМИНГ
        // ===================================================================

        async function send() {
            const msg = textarea.value.trim();
            if (!msg) return;

            // 1. Убираем приветственный экран
            if (firstMessage) {
                document.getElementById("welcome").style.opacity = "0";
                setTimeout(() => document.getElementById("welcome").style.display = "none", 500);
                firstMessage = false;
            }

            // 2. Добавляем сообщение пользователя
            chat.innerHTML += `<div class="msg user">${msg.replace(/\n/g, "<br>")}</div>`;
            textarea.value = "";
            autoResize();
            chat.scrollTop = chat.scrollHeight;

            // 3. Добавляем ТРИ ТОЧКИ (индикатор печати)
            const typingDiv = document.createElement("div");
            typingDiv.className = "msg bot typing-indicator";
            typingDiv.innerHTML = `<span></span><span></span><span></span>`;
            chat.appendChild(typingDiv);
            chat.scrollTop = chat.scrollHeight;
            
            // 4. Отправка запроса на СТРИМИНГ
            const res = await fetch("/stream_chat", { // НОВЫЙ URL
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: msg })
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let botMessageText = "";

            // Создаем DIV для ответа, который будем заполнять
            const botReplyDiv = document.createElement("div");
            botReplyDiv.className = "msg bot";
            chat.appendChild(botReplyDiv);
            chat.scrollTop = chat.scrollHeight;

            // 5. Читаем поток (SSE)
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                // Разделяем поток на отдельные SSE-сообщения
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataString = line.substring(6).trim();
                        
                        if (dataString === '[DONE]') {
                            break;
                        }
                        
                        try {
                            const data = JSON.parse(dataString); // Парсим JSON, как мы настроили в Flask
                            const content = data.content || "";
                            
                            // Добавляем и отображаем кусочек
                            botMessageText += content; 
                            botReplyDiv.innerHTML = botMessageText.replace(/\n/g, "<br>");
                            chat.scrollTop = chat.scrollHeight;
                            
                        } catch (e) {
                            // Игнорируем ошибки парсинга, если пришел неполный JSON
                            console.error("JSON Error:", e);
                        }
                    }
                }
            }
            
            // 6. Удаляем индикатор печати
            typingDiv.remove();
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
