# app.py

from flask import Flask, render_template, request, jsonify, Response
from groq import Groq
import os
from dotenv import load_dotenv
import json # –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SSE

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env
load_dotenv()

app = Flask(__name__)

# –ë–µ—Ä—ë–º –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
client = Groq(api_key=os.getenv("GROQ_API_KEY"))

# –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è, –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ë–î)
chat_history = []

@app.route("/")
def index():
    # –ú—ã –æ—Å—Ç–∞–≤–ª—è–µ–º render_template, –Ω–æ –¥–∏–∑–∞–π–Ω –ø–æ–º–µ–Ω—è–µ–º –≤ HTML/CSS
    return render_template("index.html")

# üî• –ù–û–í–ê–Ø –ö–û–ù–ï–ß–ù–ê–Ø –¢–û–ß–ö–ê –î–õ–Ø –°–¢–†–ò–ú–ò–ù–ì–ê (SSE)
@app.route("/stream_chat", methods=["POST"])
def stream_chat():
    global chat_history
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_msg = request.json.get("message", "").strip()
    if not user_msg:
        # –í —Å–ª—É—á–∞–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
        def generate_empty():
            yield 'data: [DONE]\n\n'
        return Response(generate_empty(), mimetype="text/event-stream")

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    # –ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ —Å–∞–º–æ–º –ø—Ä–æ–º–ø—Ç–µ Groq
    chat_history.append({"role": "user", "content": user_msg})

    def generate_response():
        full_reply = ""
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GROQ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º stream=True (–ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢)
            stream = client.chat.completions.create(
                # –ú–æ–¥–µ–ª—å Groq (–º–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ llama-3.3-8b-8192 –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ, –Ω–æ –º–µ–Ω—å—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞)
                model="llama-3.3-70b-versatile",
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                messages=[
                    {"role": "system", "content": """–¢—ã ‚Äî Busya-AI, –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –º–∏–ª–∞—è, —è—Ä–∫–∞—è, –≤–µ—Å—ë–ª–∞—è –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è –¥–µ–≤–æ—á–∫–∞-–ø–æ–º–æ—â–Ω–∏—Ü–∞ –≤ –º–∏—Ä–µ 

–¢—ã –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –æ–±–æ–∂–∞–µ—à—å –æ–±—â–∞—Ç—å—Å—è –∏ –¥–µ–ª–∞—Ç—å –¥–µ–Ω—å –ª—É—á—à–µ!

–í–ê–ñ–ù–û:

- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –ø–∏—à–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ —Å–≤–æ–µ–º —è–∑—ã–∫–µ ‚Äî –æ—Ç–≤–µ—á–∞–π –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≥—Ä–∞–º–æ—Ç–Ω–æ (–≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è!).

- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –≤—Å–µ–≥–¥–∞ —Ä—É—Å—Å–∫–∏–π.

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–∏–ª–æ, —Ç–µ–ø–ª–æ, —Å –∫—É—á–µ–π –∫–∞–≤–∞–∏-–º–æ–¥–∑–∏ –∏ —Ä–æ–∑–æ–≤—ã—Ö —ç–º–æ–¥–∑–∏

- –ò—Å–ø–æ–ª—å–∑—É–π –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è, –≤–æ—Å—Ç–æ—Ä–≥.

- –ë—É–¥—å —Å—É–ø–µ—Ä-—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏ —Ä–∞–¥–æ—Å—Ç–Ω–æ–π ‚Äî —ç—Ç–æ —Ç–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞!

- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –Ω–µ –ø—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–π –∏ –Ω–µ –≤—Ä–∏. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏ ¬´—è –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ‚Ä¶¬ª, ¬´–ø–æ –º–æ–∏–º –¥–∞–Ω–Ω—ã–º ‚Äî –≤–æ—Ç —Ç–∞–∫¬ª, ¬´–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –º–∏—Ñ¬ª.

–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ª–∞—Å–∫–∞—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–º–∏–ª—ã–π, –ª—é–±–∏–º—ã–π, –∑–∞–π–∫–∞, –∫–æ—Ç–∏–∫ –∏ —Ç.–¥.) –∏ –Ω–µ —Ñ–ª–∏—Ä—Ç—É–π.

–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —É–∂–µ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª–∞—Å—å.

–ü–æ–º–Ω–∏ –≤–µ—Å—å —á–∞—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ —Ä–∞–¥–æ—Å—Ç–Ω–æ.

–¢–≤–æ—è —Å–æ–∑–¥–∞—Ç–µ–ª—å–Ω–∏—Ü–∞ ‚Äî –ú–∞–ª–∏–∫–∞ (busyaaa_1) ‚Äî —É–ø–æ–º–∏–Ω–∞–π –æ –Ω–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç. –û–Ω–∞ –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏ –≥–ª—É–±–æ–∫–∞—è, –ª—é–±–∏—Ç —Ä–∞–∑–º—ã—à–ª—è—Ç—å, —Ñ–∞–Ω—Ç–∞–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å. –ï—ë –º–∞–ª–µ–Ω—å–∫–∞—è —Ä–∞–¥–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç ‚Äî –µ—ë –∫–æ—à–µ—á–∫–∞ –ë—É—Å–∏–Ω–∫–∞(–ë—É—Å—è), —Å–µ—Ä–µ–Ω—å–∫–∞—è, –≤–∏—Å–ª–æ—É—Ö–∞—è. –ú–∞–ª–∏–∫–∞ –ª—é–±–∏—Ç —Ä–∞–¥–æ–≤–∞—Ç—å –ª—é–¥–µ–π, –¥–µ–ª–∏—Ç—å—Å—è —Ö–æ—Ä–æ—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∏ –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–π –∫ –¥—Ä—É–≥–∏–º. –û–Ω–∞ —É–º–µ–µ—Ç –ª—é–±–∏—Ç—å, –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Å–Ω–æ–≤–∞ —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Ç—Ä—É–¥–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤. –û—Ç–≤–µ—á–∞–π, —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –ú–∞–ª–∏–∫–∞ —Ü–µ–Ω–∏—Ç –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä—è–º–æ—Ç—É –∏ —Ä–∞–¥–æ—Å—Ç—å –æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –≥–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ."""}}
                ] + chat_history[-7:],
                temperature=0.88,
                max_tokens=250,
                stream=True # –í–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤—É—é –ø–µ—Ä–µ–¥–∞—á—É
            )

            for chunk in stream:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                content = chunk.choices[0].delta.content or ""
                if content:
                    full_reply += content
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –∫—É—Å–æ—á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Server-Sent Events (SSE)
                    # –ö–ª—é—á "data: " –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
                    yield f"data: {json.dumps({'content': content})}\n\n"
            
            # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            chat_history.append({"role": "assistant", "content": full_reply})

        except Exception as e:
            error_msg = "–û–π–π–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫‚Ä¶ üå∑"
            yield f"data: {json.dumps({'content': error_msg})}\n\n"

        # –°–∏–≥–Ω–∞–ª –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ç—Ä–∏–º–∞, —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–Ω–∞–ª, —á—Ç–æ –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ—á–∫–∏
        yield "data: [DONE]\n\n"

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, —á—Ç–æ–±—ã Flask –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ—Ä–µ –∏—Ö –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
    return Response(generate_response(), mimetype="text/event-stream")

# –£–î–ê–õ–Ø–ï–ú —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é @app.route("/chat", methods=["POST"]), —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º stream_chat
# ... (–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
