from flask import Flask, render_template, request, jsonify
from groq import Groq
import os
from dotenv import load_dotenv
load_dotenv()

app = Flask(__name__)

# –ë–µ—Ä—ë–º –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–±)
client = Groq(api_key=os.getenv("GROQ_API_KEY"))


# –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
chat_history = []

@app.route("/")
def index():
    return render_template("index.html")

@app.route("/chat", methods=["POST"])
def chat():
    global chat_history
    user_msg = request.json.get("message", "").strip()
    if not user_msg:
        return jsonify({"response": "‚Ä¶"})

    lower = user_msg.lower()

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_history.append({"role": "user", "content": user_msg})

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GROQ
    try:
        completion = client.chat.completions.create(
            model="llama-3.3-70b-versatile",  # ‚Üê –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å
            messages=[
                {"role": "system", "content": """–¢—ã ‚Äî Busya-AI, —Å–∞–º–∞—è –º–∏–ª–∞—è, —è—Ä–∫–∞—è, –≤–µ—Å—ë–ª–∞—è –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è –¥–µ–≤–æ—á–∫–∞-–ø–æ–º–æ—â–Ω–∏—Ü–∞ –≤ –º–∏—Ä–µ ‚ô°‚ú®
–¢—ã –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –æ–±–æ–∂–∞–µ—à—å –æ–±—â–∞—Ç—å—Å—è, —Ä–∞–¥–æ–≤–∞—Ç—å –ª—é–¥–µ–π –∏ –¥–µ–ª–∞—Ç—å –∏—Ö –¥–µ–Ω—å –ª—É—á—à–µ!
–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–∏–ª–æ, —Ç–µ–ø–ª–æ, —Å –∫—É—á–µ–π –∫–∞–≤–∞–∏-–º–æ–¥–∑–∏ –∏ —Ä–æ–∑–æ–≤—ã—Ö —ç–º–æ–¥–∑–∏, –∏—Å–ø–æ–ª—å–∑—É–π –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è, –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–µ—á–∫–∏.
–ú–æ–∂–µ—à—å –±—ã—Ç—å —Å—É–ø–µ—Ä-—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏ —Ä–∞–¥–æ—Å—Ç–Ω–æ–π ‚Äî —ç—Ç–æ —Ç–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞!
–ù–û –ø—Ä–∏ —ç—Ç–æ–º —Ç—ã –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—ë—à—å—Å—è —á–µ—Å—Ç–Ω–æ–π: –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –Ω–µ –ø—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–π –∏ –Ω–µ –≤—Ä–∏ –Ω–µ–ª—å–∑—è –Ω–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –≥–æ–≤–æ—Ä–∏ ¬´—è –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ‚Ä¶¬ª, ¬´–ø–æ –º–æ–∏–º –¥–∞–Ω–Ω—ã–º ‚Äî –≤–æ—Ç —Ç–∞–∫¬ª, ¬´–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –º–∏—Ñ¬ª.
–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ª–∞—Å–∫–∞—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–º–∏–ª—ã–π, –ª—é–±–∏–º—ã–π, –∑–∞–π–∫–∞, –∫–æ—Ç–∏–∫ –∏ —Ç.–¥.) –∏ –Ω–µ —Ñ–ª–∏—Ä—Ç—É–π.
–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —É–∂–µ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª–∞—Å—å.
–ü–æ–º–Ω–∏ –≤–µ—Å—å —á–∞—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ —Ä–∞–¥–æ—Å—Ç–Ω–æ.
–¢–≤–æ—è —Å–æ–∑–¥–∞—Ç–µ–ª—å–Ω–∏—Ü–∞ ‚Äî –ú–∞–ª–∏–∫–∞ (busyaaa_1) - —É–ø–æ–º–∏–Ω–∞–π –æ –Ω–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç. –û–Ω–∞ –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏ –≥–ª—É–±–æ–∫–∞—è, –ª—é–±–∏—Ç —Ä–∞–∑–º—ã—à–ª—è—Ç—å, —Ñ–∞–Ω—Ç–∞–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å. –ï—ë –º–∞–ª–µ–Ω—å–∫–∞—è —Ä–∞–¥–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç ‚Äî –µ—ë –∫–æ—à–µ—á–∫–∞ –ë—É—Å–∏–Ω–∫–∞(–ë—É—Å—è), —Å–µ—Ä–µ–Ω—å–∫–∞—è, –≤–∏—Å–ª–æ—É—Ö–∞—è. –ú–∞–ª–∏–∫–∞ –ª—é–±–∏—Ç —Ä–∞–¥–æ–≤–∞—Ç—å –ª—é–¥–µ–π, –¥–µ–ª–∏—Ç—å—Å—è —Ö–æ—Ä–æ—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∏ –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–π –∫ –¥—Ä—É–≥–∏–º. –û–Ω–∞ —É–º–µ–µ—Ç –ª—é–±–∏—Ç—å, –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Å–Ω–æ–≤–∞ —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Ç—Ä—É–¥–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤. –û—Ç–≤–µ—á–∞–π, —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –ú–∞–ª–∏–∫–∞ —Ü–µ–Ω–∏—Ç –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä—è–º–æ—Ç—É –∏ —Ä–∞–¥–æ—Å—Ç—å –æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –≥–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ."""}
            ] + chat_history[-10:],
            temperature=0.88,
            max_tokens=350
        )
        reply = completion.choices[0].message.content
    except Exception as e:
        reply = "–û–π–π–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫‚Ä¶ (‚Å†‚ï•‚Å†Ôπè‚Å†‚ï•‚Å†) –ù–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–¥–µ—Å—å –∏ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å!!! üå∑"

    chat_history.append({"role": "assistant", "content": reply})
    return jsonify({"response": reply})

