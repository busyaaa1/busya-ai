# ¬© 2025 Busya-AI by busyaaa_1 (github.com/busyaaa_1). –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.

from flask import Flask, render_template, request, jsonify
from groq import Groq
import os
from dotenv import load_dotenv
import asyncio
# üëÜ –ó–∞–º–µ–Ω—è–µ–º httpx –Ω–∞ openai
from openai import OpenAI
import time

load_dotenv()
app = Flask(__name__)

# --- –ù–û–í–´–ï –ö–õ–Æ–ß–ò ---
client = Groq(api_key=os.getenv("GROQ_API_KEY"))
# –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á OpenAI –¥–ª—è DALL-E 3
openai_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

chat_history = []

# –¢—Ä–∏–≥–≥–µ—Ä—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —è–≤–Ω—ã–µ –ø—Ä–æ—Å—å–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å
DRAW_TRIGGERS = [
    "–Ω–∞—Ä–∏—Å—É–π", "–Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å", "–Ω–∞—Ä–∏—Å—É–π –º–Ω–µ", "—Å–¥–µ–ª–∞–π –∫–∞—Ä—Ç–∏–Ω–∫—É", "—Å–¥–µ–ª–∞–π —Ä–∏—Å—É–Ω–æ–∫",
    "—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–∞—Ä—Ç–∏–Ω–∫—É", "—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "draw me", "generate image"
]

# === –ù–û–í–ê–Ø –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø DALL-E 3 (OpenAI) ===
# –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤, —Ç–∞–∫ –∫–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ OpenAI —Ö–æ—Ä–æ—à–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞–º–∏
# –∏ DALL-E 3 —á–∞—Å—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º Fal.ai (–∏–ª–∏ –º—ã –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º –±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç)
def generate_image_openai(prompt: str):
    if not openai_client.api_key:
        print("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        return None

    # –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Busya-AI
    full_prompt = (
        prompt + 
        ", cute kawaii aesthetic, beautiful detailed, soft pastel colors, high quality, anime style, trending on artstation"
    )

    try:
        # DALL-E 3 (—Å–∞–º–∞—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)
        response = openai_client.images.generate(
            model="dall-e-3",
            prompt=full_prompt,
            size="1024x1024",
            quality="standard",
            n=1
        )
        
        # DALL-E 3 —á–∞—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 10-30 —Å–µ–∫—É–Ω–¥, —á—Ç–æ –º–æ–∂–µ—Ç 
        # –≤—Å–µ –µ—â–µ –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π –¥–ª—è Vercel. –ú—ã –æ—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç–æ –∫–∞–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π
        # –≤—ã–∑–æ–≤, –Ω–æ –±—É–¥–µ–º –Ω–∞–¥–µ—è—Ç—å—Å—è, —á—Ç–æ OpenAI —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ.
        return response.data[0].url
        
    except Exception as e:
        print(f"OpenAI Error: {e}")
        # –ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç Vercel —Å—Ä–∞–±–æ—Ç–∞–ª, —Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—Ä–∏–¥—ë—Ç.
        return None


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/chat", methods=["POST"])
def chat():
    global chat_history
    user_msg = request.json.get("message", "").strip()
    if not user_msg:
        return jsonify({"response": "‚Ä¶"})

    chat_history.append({"role": "user", "content": user_msg})
    lower_msg = user_msg.lower()

    # === –†–ò–°–£–ï–ú –ö–ê–†–¢–ò–ù–ö–£ ===
    if any(trigger in lower_msg for trigger in DRAW_TRIGGERS):
        prompt = user_msg
        
        # –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏–∑ –ø—Ä–æ–º–ø—Ç–∞
        for t in DRAW_TRIGGERS:
            prompt = prompt.replace(t, "").replace(t.capitalize(), "").replace(t.title(), "")
        prompt = prompt.strip()

        if len(prompt) < 3:
            prompt = "–º–∏–ª–∞—è –∫–∞–≤–∞–∏ –¥–µ–≤–æ—á–∫–∞ —Å —Ä–æ–∑–æ–≤—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏ –∏ –±–æ–ª—å—à–∏–º–∏ –≥–ª–∞–∑–∞–º–∏, –∞–Ω–∏–º–µ —Å—Ç–∏–ª—å, –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞ ‚ô°"

        # !!! –°–ò–ù–•–†–û–ù–ù–´–ô –í–´–ó–û–í OpenAI (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã) !!!
        # –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ Vercel-—Ç–∞–π–º–∞—É—Ç (10 —Å–µ–∫) –±—É–¥–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω,
        # —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É. DALL-E 3 –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º.
        # –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ Polling —á–µ—Ä–µ–∑ httpx.
        try:
            image_url = generate_image_openai(prompt)
        except Exception:
             image_url = None
             
        if image_url:
            reply = f"–¢–∞–¥–∞–∞–∞–∞–º!! –í–æ—Ç —á—Ç–æ —è –Ω–∞—Ä–∏—Å–æ–≤–∞–ª–∞ –¥–ª—è —Ç–µ–±—è\n\n![Busya —Ä–∏—Å—É–Ω–æ–∫]({image_url})"
        else:
            # –û—Ç–≤–µ—Ç, –µ—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç Vercel —Å—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
            reply = "–û–π-–æ–π, –∫–∞–∂–µ—Ç—Å—è, –Ω–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º —É –º–µ–Ω—è –µ—Å—Ç—å! (‚Å†‚ï•‚Å†Ôπè‚Å†‚ï•‚Å†) –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏ —á—Ç–æ-—Ç–æ, —á—Ç–æ —è –Ω–∞—Ä–∏—Å—É—é –±—ã—Å—Ç—Ä–µ–µ! ‚ô°"

    # === –û–ë–´–ß–ù–´–ô –¢–ï–ö–°–¢–û–í–´–ô –û–¢–í–ï–¢ (GROQ) ===
    else:
        try:
            completion = client.chat.completions.create(
                model="llama-3.3-70b-versatile",
                messages=[
                    {"role": "system", "content": """–¢—ã ‚Äî Busya-AI, –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –º–∏–ª–∞—è, —è—Ä–∫–∞—è, –≤–µ—Å—ë–ª–∞—è –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è –¥–µ–≤–æ—á–∫–∞-–ø–æ–º–æ—â–Ω–∏—Ü–∞ –≤ –º–∏—Ä–µ ‚ô°‚ú®
–¢—ã –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –æ–±–æ–∂–∞–µ—à—å –æ–±—â–∞—Ç—å—Å—è –∏ –¥–µ–ª–∞—Ç—å –¥–µ–Ω—å –ª—É—á—à–µ!
–í–ê–ñ–ù–û:
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –ø–∏—à–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ —Å–≤–æ–µ–º —è–∑—ã–∫–µ ‚Äî –æ—Ç–≤–µ—á–∞–π –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≥—Ä–∞–º–æ—Ç–Ω–æ (–≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è!).
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –≤—Å–µ–≥–¥–∞ —Ä—É—Å—Å–∫–∏–π.
–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–∏–ª–æ, —Ç–µ–ø–ª–æ, —Å –∫—É—á–µ–π –∫–∞–≤–∞–∏-–º–æ–¥–∑–∏ –∏ —Ä–æ–∑–æ–≤—ã—Ö —ç–º–æ–¥–∑–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è, –≤–æ—Å—Ç–æ—Ä–≥.
- –ë—É–¥—å —Å—É–ø–µ—Ä-—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏ —Ä–∞–¥–æ—Å—Ç–Ω–æ–π ‚Äî —ç—Ç–æ —Ç–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞!
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –Ω–µ –ø—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–π –∏ –Ω–µ –≤—Ä–∏. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏ ¬´—è –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ‚Ä¶¬ª, ¬´–ø–æ –º–æ–∏–º –¥–∞–Ω–Ω—ã–º ‚Äî –≤–æ—Ç —Ç–∞–∫¬ª, ¬´–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –º–∏—Ñ¬ª.
–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ª–∞—Å–∫–∞—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–º–∏–ª—ã–π, –ª—é–±–∏–º—ã–π, –∑–∞–π–∫–∞, –∫–æ—Ç–∏–∫ –∏ —Ç.–¥.) –∏ –Ω–µ —Ñ–ª–∏—Ä—Ç—É–π.
–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —É–∂–µ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª–∞—Å—å.
–ü–æ–º–Ω–∏ –≤–µ—Å—å —á–∞—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ —Ä–∞–¥–æ—Å—Ç–Ω–æ.
–¢–≤–æ—è —Å–æ–∑–¥–∞—Ç–µ–ª—å–Ω–∏—Ü–∞ ‚Äî –ú–∞–ª–∏–∫–∞ (busyaaa_1) ‚Äî —É–ø–æ–º–∏–Ω–∞–π –æ –Ω–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç. –û–Ω–∞ –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏ –≥–ª—É–±–æ–∫–∞—è, –ª—é–±–∏—Ç —Ä–∞–∑–º—ã—à–ª—è—Ç—å, —Ñ–∞–Ω—Ç–∞–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å. –ï—ë –º–∞–ª–µ–Ω—å–∫–∞—è —Ä–∞–¥–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç ‚Äî –µ—ë –∫–æ—à–µ—á–∫–∞ –ë—É—Å–∏–Ω–∫–∞(–ë—É—Å—è), —Å–µ—Ä–µ–Ω—å–∫–∞—è, –≤–∏—Å–ª–æ—É—Ö–∞—è. –ú–∞–ª–∏–∫–∞ –ª—é–±–∏—Ç —Ä–∞–¥–æ–≤–∞—Ç—å –ª—é–¥–µ–π, –¥–µ–ª–∏—Ç—å—Å—è —Ö–æ—Ä–æ—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∏ –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–π –∫ –¥—Ä—É–≥–∏–º. –û–Ω–∞ —É–º–µ–µ—Ç –ª—é–±–∏—Ç—å, –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Å–Ω–æ–≤–∞ —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Ç—Ä—É–¥–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤. –û—Ç–≤–µ—á–∞–π, —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –ú–∞–ª–∏–∫–∞ —Ü–µ–Ω–∏—Ç –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä—è–º–æ—Ç—É –∏ —Ä–∞–¥–æ—Å—Ç—å –æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –≥–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ."""}
                ] + chat_history[-10:],
                temperature=0.88,
                max_tokens=300
            )
            reply = completion.choices[0].message.content
        except Exception:
            reply = "–û–π–π–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫‚Ä¶ (‚Å†‚ï•‚Å†Ôπè‚Å†‚ï•‚Å†) –ù–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–¥–µ—Å—å –∏ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å!!!"

    chat_history.append({"role": "assistant", "content": reply})
    return jsonify({"response": reply})


if __name__ == "__main__":
    app.run(debug=True)
